---
title:  Node.js 性能优化小技巧
date: 2017-07-13 20:21:38
tags:  Node.js 性能优化 
---

# Node.js 性能优化小技巧

## 避免使用同步代码
在设计上，node.js是单线程的。为了能让一个单线程处理许多并发的请求，你可以永远不要让线程等待阻塞，同步或长时间运行的操作。Node.js的一个显著特征是：它从上到下的设计和实现都是为了实现异步。这让它非常适合用于事件型程序。

不幸的是，还是有可能会发生同步/阻塞的调用。例如，许多文件系统操作同时拥有同步和异步的版本，比如writeFile和writeFileSync。即使你用代码来控制同步方法，但还是有可能不注意地用到阻塞调用的外部函数库。当你这么做时，对性能的影响是极大的。

如果我们不做性能测试那么就会很容易忽略这个问题。当以developer box中一个node.js实例来作为标准测试，这个同步调用将导致性能从每秒上千次的请求降至只有几十个。

## 关闭套接字池
Node.js的http客户端会自动地使用套接字池：默认地，它会限制每台主机只能有5个套接字。虽然套接字的重复使用可能会让资源的增加在控制之下，但如果你需要处理许多数据来自于同一主机的并发请求时，将会导致一系列的瓶颈。在这种情况下，增大maxSockets 的值或关闭套接字池是个好主意：

## 不要让静态资源使用Node.js
对于css和图片等静态资源，用标准的WebServer而不是Node.js。例如，领英移动使用的是nginx。我们同时还利用内容传递网络（CDNs），它能将世界范围内的静态资拷贝到服务器上。
    
    这有两个好处：
    （1）能减少我们node.js服务器的负载量
    （2）CDNs可以让静态内容在离用户较近的服务器上传递，以此来减少等待时间。
性能的提升来自于这些地方：如第三点所说，静态javascript模板能通过webserver（比如nginx）在服务器端提供，或者用更好的CDN来实现。此外，JavaScript模板能缓存在浏览器中或存储在本地，所有初始页面加载以后，唯一需要发送给客户端的数据就是JSON，这将是最有效果的。这个方法能极大性地减少CPU，IO，和Node.js的负载量。
<!-- more -->
## 使用gzip
许多服务器和客户端支持gzip来压缩请求和应答。无论是应答客户端还是向远程服务器发送请求，请确保充分使用它。


## 并行化
试着让你所有的阻塞操作－向远程服务发送请求，DB调用，文件系统访问并行化。这将能减少最慢的阻塞操作的等待时间，而不是所有阻塞操作的等待时间。为了保持回调和错误处理的干净，我们使用Step来控制流量。

## Session自由化

许多express的例子都包含如下的配置：
app.use(express.session({ secret: "keyboard cat" }));
默认地，session数据是存储在内存中的，这会给服务器增加巨大的开销，特别是随着用户量的增长。你可以使用一个外部session存储，比如MongoDB或Redis，不过每一个请求将会导致远程调用来取得session数据的开销。在可能的情况下，最好的选择就是在服务器端存储所有的无状态数据。通过不包含上述express配置让session自由化，你会看到更好的性能。

## 使用二进制模块
如果可能，用二进制模块取代JavaScript模块。例如，当我们从用JavaScript写的SHA模块转换到Node.js的编译版本，我们会看到性能的一个大跃进：

## 用标准的 V8 JavaScript 取代客户端库
许多JavaScript库都是为了在web浏览器上使用而创建的，因为在JavaScript环境不同时：比如，一些浏览器支持forEach，map和reduce这样的函数，但有些浏览器不支持。因此客户端库通常用许多低效的代码来克服浏览器的差异。另一方面，在Node.js中，你能确切地知道哪些JavaScript方法是有效的：V8 JavaScript引擎支撑Node.js实现ECMA-262第五版中指定的ECMAScript。直接用标准的V8 JavaScript函数替代客户端库，你会发现性能得到显著的提高。

## 让你的代码保持小且轻
使用移动设备会让访问速度慢且延迟高，这告诉我们要让我们的代码保持小且轻。对于服务器代码也保持同样的理念。偶尔回头看看你的决定且问自己像这样的问题：“我们真的需要这个模块吗？”，“我们为什么用这个框架，它的开销值得我们使用吗？”，“我们能用简便的方法实现它吗？”。小轻且的代码通常更高效、快速。


## 如果可以，在用客户端渲染
现在有超多功能强劲的客户端 MVC/MVVM 框架，比如说 AngularJS, Ember, Meteor, 等等，构建一个单页面应用变得非常简单。基本上，你只要公开一个 API，返回 JSON 响应给客户端就可以了，而不需要在服务端渲染页面。在客户端，你可以用框架来组织 JSON 然后把它们显示在 UI 上。服务端只发送 JSON 响应可以节省带宽，改善性能，因为你不需要在每个响应里面都返回布局标记了，对吧，你只需要返回纯 JSON，然后在客户端渲染它们。

## 在 Node 前面用 Nginx

Nginx 是个微小型轻量 Web 服务器，用它可以降低你的 Node.js 服务器的负载。你可以把静态资源配置到 nginx 上，而不是在 Node 上。你可以在 nginx 上用 gzip 压缩响应，让所有的响应都变得更小。所以，如果你有个正在营运的产品，我觉得你应该会想用 nginx 来改善运行速度的。

##  打包 JavaScript

最后，你还可以大大提高页面应用速度，通过把多个 JS 文件打包。当浏览器在页面渲染中碰到 `<script>` 元素的时候会被堵塞，直到拿到这个脚本才继续运行(除非设置了异步属性)。比如，如果你的页面有五个 JavaScript 文件，浏览器会发出五个独立的 HTTP 请求来获取他们。如果把这五个文件压缩打包成一个，整体性能将可以大幅提升。CSS 文件也是一样。你可以用诸如 Grunt/Gulp 这样的编译工具来打包你的资源文件。

[Node 性能优化](https://segmentfault.com/a/1190000007621011)